<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kindle Markdown Editor - WYSIWYG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #ffffff;
            color: #000000;
            height: 100vh;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            overflow: hidden;
        }

        /* Header */
        .header {
            background-color: #ffffff;
            padding: 8px 12px;
            border-bottom: 2px solid #000000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 16px;
            font-weight: 600;
            color: #000000;
        }

        .header-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .header-btn {
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            padding: 4px 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            min-height: 36px;
            min-width: 36px;
        }

        .header-btn:active {
            background-color: #000000;
            color: #ffffff;
        }

        /* Editor Container */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* WYSIWYG Editor */
        #editor {
            width: 100%;
            flex: 1;
            padding: 16px;
            background-color: #ffffff;
            color: #000000;
            border: none;
            outline: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            overflow-y: auto;
            overflow-x: hidden;
            word-wrap: break-word;
            -webkit-user-modify: read-write-plaintext-only;
        }

        #editor:focus {
            outline: none;
        }

        .hidden {
            display: none !important;
        }

        /* Editor content styles */
        #editor h1, #editor h2, #editor h3, #editor h4, #editor h5, #editor h6 {
            margin-top: 20px;
            margin-bottom: 12px;
            font-weight: 600;
            line-height: 1.25;
            color: #000000;
        }

        #editor h1 {
            font-size: 2em;
            border-bottom: 2px solid #000000;
            padding-bottom: 0.3em;
        }

        #editor h2 {
            font-size: 1.5em;
            border-bottom: 1px solid #000000;
            padding-bottom: 0.3em;
        }

        #editor h3 { font-size: 1.25em; }
        #editor h4 { font-size: 1em; }
        #editor h5 { font-size: 0.875em; }
        #editor h6 { font-size: 0.85em; color: #333333; }

        #editor p {
            margin-bottom: 12px;
            line-height: 1.6;
        }

        #editor strong, #editor b {
            font-weight: 700;
        }

        #editor em, #editor i {
            font-style: italic;
        }

        #editor code {
            background-color: #f0f0f0;
            padding: 2px 6px;
            border: 1px solid #cccccc;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.9em;
            color: #000000;
        }

        #editor pre {
            background-color: #f0f0f0;
            padding: 12px;
            border: 1px solid #cccccc;
            overflow-x: auto;
            margin-bottom: 12px;
        }

        #editor pre code {
            background-color: transparent;
            padding: 0;
            border: none;
        }

        #editor blockquote {
            border-left: 4px solid #000000;
            padding-left: 16px;
            margin-bottom: 12px;
            color: #333333;
        }

        #editor ul, #editor ol {
            margin-bottom: 12px;
            padding-left: 32px;
        }

        #editor li {
            margin-bottom: 6px;
        }

        #editor a {
            color: #0000ff;
            text-decoration: underline;
        }

        #editor hr {
            border: none;
            border-top: 2px solid #000000;
            margin: 20px 0;
        }

        /* Bottom Toolbar */
        .bottom-toolbar {
            background-color: #ffffff;
            border-top: 2px solid #000000;
            padding: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .nav-btn {
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #000000;
            font-size: 18px;
            font-weight: bold;
            min-width: 50px;
            min-height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            -webkit-user-select: none;
        }

        .nav-btn:active {
            background-color: #000000;
            color: #ffffff;
        }

        .nav-btn.active {
            background-color: #000000;
            color: #ffffff;
        }

        .nav-btn.modifier {
            font-size: 12px;
            min-width: 60px;
        }

        /* Status Bar */
        .status-bar {
            background-color: #ffffff;
            border-top: 1px solid #000000;
            padding: 4px 12px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .status-item {
            color: #333333;
        }

        /* Scrollbar styling for e-ink */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #ffffff;
        }

        ::-webkit-scrollbar-thumb {
            background: #000000;
        }

        /* File input hidden */
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <h1>üìù Kindle Markdown Editor</h1>
        <div class="header-buttons">
            <button class="header-btn" id="newBtn" title="New Document">üóé</button>
            <button class="header-btn" id="openBtn" title="Open File">üìÇ</button>
            <button class="header-btn" id="saveBtn" title="Save File">üíæ</button>
        </div>
    </div>

    <!-- Editor Container -->
    <div class="editor-container">
        <div id="editor" contenteditable="true"></div>
    </div>

    <!-- Bottom Toolbar -->
    <div class="bottom-toolbar">
        <button class="nav-btn modifier" id="ctrlBtn" title="Control Key">Ctrl</button>
        <button class="nav-btn modifier" id="shiftBtn" title="Shift Key">Shift</button>
        <button class="nav-btn" id="leftBtn" title="Left Arrow">‚Üê</button>
        <button class="nav-btn" id="upBtn" title="Up Arrow">‚Üë</button>
        <button class="nav-btn" id="downBtn" title="Down Arrow">‚Üì</button>
        <button class="nav-btn" id="rightBtn" title="Right Arrow">‚Üí</button>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <span class="status-item" id="wordCount">Words: 0</span>
        <span class="status-item" id="charCount">Chars: 0</span>
        <span class="status-item" id="autoSaveStatus">Auto-saved ‚úì</span>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" accept=".md,.txt" />

    <script>
        // DOM Elements
        const editor = document.getElementById('editor');
        const wordCount = document.getElementById('wordCount');
        const charCount = document.getElementById('charCount');
        const autoSaveStatus = document.getElementById('autoSaveStatus');
        const newBtn = document.getElementById('newBtn');
        const openBtn = document.getElementById('openBtn');
        const saveBtn = document.getElementById('saveBtn');
        const fileInput = document.getElementById('fileInput');
        
        // Toolbar buttons
        const ctrlBtn = document.getElementById('ctrlBtn');
        const shiftBtn = document.getElementById('shiftBtn');
        const leftBtn = document.getElementById('leftBtn');
        const upBtn = document.getElementById('upBtn');
        const downBtn = document.getElementById('downBtn');
        const rightBtn = document.getElementById('rightBtn');

        // State
        let ctrlActive = false;
        let shiftActive = false;
        let autoSaveTimer = null;

        // ===== Simple Markdown Parser =====
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Parse and render markdown in real-time
        function parseMarkdown(text) {
            if (!text || text.trim() === '') return '<p><br></p>';
            
            let html = text;
            
            // Parse code blocks (must be before inline code)
            html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
                return `<pre><code>${escapeHtml(code.trim())}</code></pre>`;
            });
            
            // Parse inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
            
            // Parse headers
            html = html.replace(/^##### (.*?)$/gm, '<h5>$1</h5>');
            html = html.replace(/^#### (.*?)$/gm, '<h4>$1</h4>');
            html = html.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
            html = html.replace(/^## (.*?)$/gm, '<h2>$1</h2>');
            html = html.replace(/^# (.*?)$/gm, '<h1>$1</h1>');
            
            // Parse bold (** or __)
            html = html.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');
            
            // Parse italic (* or _)
            html = html.replace(/\*([^\*]+)\*/g, '<em>$1</em>');
            html = html.replace(/_([^_]+)_/g, '<em>$1</em>');
            
            // Parse links
            html = html.replace(/\[([^\]]+)\]\(([^\)]+)\)/g, '<a href="$2">$1</a>');
            
            // Parse images
            html = html.replace(/!\[([^\]]*)\]\(([^\)]+)\)/g, '<img src="$2" alt="$1">');
            
            // Parse blockquotes
            html = html.replace(/^> (.*?)$/gm, '<blockquote>$1</blockquote>');
            
            // Parse horizontal rules
            html = html.replace(/^(---+|___+|\*\*\*+)$/gm, '<hr>');
            
            // Parse lists - mark list items first
            html = html.replace(/^[\-\*\+] (.*?)$/gm, '<__UL__><li>$1</li>');
            html = html.replace(/^\d+\. (.*?)$/gm, '<__OL__><li>$1</li>');
            
            // Parse line breaks and paragraphs, and wrap lists
            const lines = html.split('\n');
            const processed = [];
            let inCode = false;
            let currentListType = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                
                if (line.startsWith('<pre>') || line.startsWith('</pre>')) {
                    inCode = !inCode;
                    processed.push(line);
                } else if (line.startsWith('<__UL__>')) {
                    if (currentListType !== 'ul') {
                        if (currentListType) {
                            processed.push(`</${currentListType}>`);
                        }
                        processed.push('<ul>');
                        currentListType = 'ul';
                    }
                    processed.push(line.replace('<__UL__>', ''));
                } else if (line.startsWith('<__OL__>')) {
                    if (currentListType !== 'ol') {
                        if (currentListType) {
                            processed.push(`</${currentListType}>`);
                        }
                        processed.push('<ol>');
                        currentListType = 'ol';
                    }
                    processed.push(line.replace('<__OL__>', ''));
                } else if (line.startsWith('<h') || line.startsWith('<hr') || 
                           line.startsWith('<blockquote') || inCode) {
                    if (currentListType) {
                        processed.push(`</${currentListType}>`);
                        currentListType = null;
                    }
                    processed.push(line);
                } else if (line.trim() === '') {
                    if (currentListType) {
                        processed.push(`</${currentListType}>`);
                        currentListType = null;
                    }
                    processed.push('<p><br></p>');
                } else if (!line.startsWith('<')) {
                    if (currentListType) {
                        processed.push(`</${currentListType}>`);
                        currentListType = null;
                    }
                    processed.push(`<p>${line}</p>`);
                } else {
                    processed.push(line);
                }
            }
            
            // Close any open list
            if (currentListType) {
                processed.push(`</${currentListType}>`);
            }
            
            html = processed.join('\n');
            
            return html;
        }

        // ===== HTML to Markdown Converter =====
        
        function htmlToMarkdown(html) {
            // Create a temporary div to parse HTML
            const temp = document.createElement('div');
            temp.innerHTML = html;
            
            let markdown = '';
            
            function processNode(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    return node.textContent;
                }
                
                if (node.nodeType !== Node.ELEMENT_NODE) {
                    return '';
                }
                
                const tag = node.tagName.toLowerCase();
                let result = '';
                
                switch (tag) {
                    case 'h1':
                        result = '# ' + node.textContent + '\n\n';
                        break;
                    case 'h2':
                        result = '## ' + node.textContent + '\n\n';
                        break;
                    case 'h3':
                        result = '### ' + node.textContent + '\n\n';
                        break;
                    case 'h4':
                        result = '#### ' + node.textContent + '\n\n';
                        break;
                    case 'h5':
                        result = '##### ' + node.textContent + '\n\n';
                        break;
                    case 'h6':
                        result = '###### ' + node.textContent + '\n\n';
                        break;
                    case 'p':
                        const pContent = Array.from(node.childNodes).map(processNode).join('');
                        result = pContent + '\n\n';
                        break;
                    case 'strong':
                    case 'b':
                        result = '**' + node.textContent + '**';
                        break;
                    case 'em':
                    case 'i':
                        result = '*' + node.textContent + '*';
                        break;
                    case 'code':
                        if (node.parentElement && node.parentElement.tagName === 'PRE') {
                            result = '```\n' + node.textContent + '\n```\n\n';
                        } else {
                            result = '`' + node.textContent + '`';
                        }
                        break;
                    case 'pre':
                        const code = node.querySelector('code');
                        if (code) {
                            result = '```\n' + code.textContent + '\n```\n\n';
                        }
                        break;
                    case 'a':
                        result = '[' + node.textContent + '](' + (node.getAttribute('href') || node.href) + ')';
                        break;
                    case 'img':
                        result = '![' + (node.alt || '') + '](' + (node.getAttribute('src') || node.src) + ')';
                        break;
                    case 'ul':
                        Array.from(node.children).forEach(li => {
                            if (li.tagName === 'LI') {
                                result += '- ' + li.textContent + '\n';
                            }
                        });
                        result += '\n';
                        break;
                    case 'ol':
                        Array.from(node.children).forEach((li, index) => {
                            if (li.tagName === 'LI') {
                                result += (index + 1) + '. ' + li.textContent + '\n';
                            }
                        });
                        result += '\n';
                        break;
                    case 'li':
                        // Handled by ul/ol
                        break;
                    case 'blockquote':
                        result = '> ' + node.textContent + '\n\n';
                        break;
                    case 'hr':
                        result = '---\n\n';
                        break;
                    case 'br':
                        result = '\n';
                        break;
                    case 'div':
                        result = Array.from(node.childNodes).map(processNode).join('');
                        break;
                    default:
                        result = Array.from(node.childNodes).map(processNode).join('');
                }
                
                return result;
            }
            
            markdown = Array.from(temp.childNodes).map(processNode).join('');
            return markdown.trim();
        }

        // Get plain text content from editor
        function getEditorText() {
            return editor.innerText || '';
        }

        // Get HTML content from editor
        function getEditorHTML() {
            return editor.innerHTML || '';
        }

        // Set editor content from HTML
        function setEditorHTML(html) {
            editor.innerHTML = html;
        }

        // Update word and character count
        function updateCounts() {
            const text = getEditorText();
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            const chars = text.length;
            
            wordCount.textContent = `Words: ${words}`;
            charCount.textContent = `Chars: ${chars}`;
        }

        // Auto-save to localStorage
        function autoSave() {
            const html = getEditorHTML();
            const markdown = htmlToMarkdown(html);
            localStorage.setItem('markdownContent', markdown);
            autoSaveStatus.textContent = 'Auto-saved ‚úì';
            
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                autoSaveStatus.textContent = '';
            }, 2000);
        }

        // Load content from localStorage
        function loadContent() {
            const savedMarkdown = localStorage.getItem('markdownContent');
            if (savedMarkdown) {
                const html = parseMarkdown(savedMarkdown);
                setEditorHTML(html);
            } else {
                // Default content
                const defaultMarkdown = `# Welcome to Kindle Markdown Editor

This is a **WYSIWYG** editor optimized for Kindle devices.

## Features
- Live markdown rendering as you type
- Bottom toolbar with navigation keys
- Touch-friendly buttons for e-ink displays
- Auto-save to localStorage
- Import/Export markdown files

### Try it out!
Type **bold text** or *italic text* and see it render immediately.

- Use the arrow keys to navigate
- Press Ctrl to enable word jumping
- Press Shift to select text`;
                
                const html = parseMarkdown(defaultMarkdown);
                setEditorHTML(html);
            }
        }

        // ===== Toolbar Button Functions =====
        
        // Toggle Ctrl state
        ctrlBtn.addEventListener('click', () => {
            ctrlActive = !ctrlActive;
            if (ctrlActive) {
                ctrlBtn.classList.add('active');
            } else {
                ctrlBtn.classList.remove('active');
            }
        });

        // Toggle Shift state
        shiftBtn.addEventListener('click', () => {
            shiftActive = !shiftActive;
            if (shiftActive) {
                shiftBtn.classList.add('active');
            } else {
                shiftBtn.classList.remove('active');
            }
        });

        // Arrow button handlers
        function simulateArrowKey(key) {
            // key should be like 'ArrowLeft', 'ArrowUp', etc.
            const event = new KeyboardEvent('keydown', {
                key: key,
                code: key,
                ctrlKey: ctrlActive,
                shiftKey: shiftActive,
                bubbles: true,
                cancelable: true
            });
            
            editor.dispatchEvent(event);
            
            // Deactivate modifiers after use (except when holding)
            // For touch interface, keep them active until manually toggled
        }

        leftBtn.addEventListener('click', () => simulateArrowKey('ArrowLeft'));
        upBtn.addEventListener('click', () => simulateArrowKey('ArrowUp'));
        downBtn.addEventListener('click', () => simulateArrowKey('ArrowDown'));
        rightBtn.addEventListener('click', () => simulateArrowKey('ArrowRight'));

        // ===== Keyboard Shortcuts =====
        
        document.addEventListener('keydown', (e) => {
            // Update modifier button states
            if (e.ctrlKey && !ctrlActive) {
                ctrlActive = true;
                ctrlBtn.classList.add('active');
            }
            if (e.shiftKey && !shiftActive) {
                shiftActive = true;
                shiftBtn.classList.add('active');
            }

            // Ctrl+S: Save file
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveToFile();
            }
            
            // Ctrl+O: Open file
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                fileInput.click();
            }
            
            // Ctrl+N: New document
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                newDocument();
            }

            // Ctrl+B: Bold
            if (e.ctrlKey && e.key === 'b') {
                e.preventDefault();
                document.execCommand('bold', false, null);
            }

            // Ctrl+I: Italic
            if (e.ctrlKey && e.key === 'i') {
                e.preventDefault();
                document.execCommand('italic', false, null);
            }

            // Tab: Insert spaces
            if (e.key === 'Tab') {
                e.preventDefault();
                document.execCommand('insertText', false, '    ');
            }
        });

        document.addEventListener('keyup', (e) => {
            // Deactivate modifier buttons when keys are released
            if (!e.ctrlKey && ctrlActive) {
                ctrlActive = false;
                ctrlBtn.classList.remove('active');
            }
            if (!e.shiftKey && shiftActive) {
                shiftActive = false;
                shiftBtn.classList.remove('active');
            }
        });

        // ===== Editor Event Handlers =====
        
        editor.addEventListener('input', () => {
            updateCounts();
            autoSave();
        });

        // Prevent default drag and drop behavior
        editor.addEventListener('drop', (e) => {
            e.preventDefault();
        });

        // ===== File Operations =====
        
        // New document
        function newDocument() {
            if (confirm('Create a new document? Unsaved changes will be lost.')) {
                editor.innerHTML = '<p><br></p>';
                editor.focus();
                localStorage.removeItem('markdownContent');
                updateCounts();
            }
        }

        newBtn.addEventListener('click', newDocument);

        // Open file
        openBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const markdown = event.target.result;
                    const html = parseMarkdown(markdown);
                    setEditorHTML(html);
                    updateCounts();
                    autoSave();
                };
                reader.readAsText(file);
            }
            fileInput.value = ''; // Reset input
        });

        // Save file
        function saveToFile() {
            const html = getEditorHTML();
            const markdown = htmlToMarkdown(html);
            const blob = new Blob([markdown], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'document.md';
            a.click();
            URL.revokeObjectURL(url);
        }

        saveBtn.addEventListener('click', saveToFile);

        // ===== Initialization =====
        
        window.addEventListener('DOMContentLoaded', () => {
            loadContent();
            updateCounts();
            editor.focus();
        });

        // Prevent zoom on double-tap (Kindle optimization)
        let lastTouchEnd = 0;
        document.addEventListener('touchend', (e) => {
            const now = Date.now();
            if (now - lastTouchEnd <= 300) {
                e.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>